---
title: "AD7280A BMS 개발기 #2 - 데이지체인 연결"
date: 2024-12-02
draft: false
tags: ["AD7280A", "BMS", "STM32", "데이지체인"]
categories: ["BMS 개발"]
series: ["AD7280A BMS 개발"]
summary: "4개 IC를 줄줄이 연결하는 데이지체인. 생각보다 까다롭다."
---

24셀을 모니터링하려면 AD7280A 4개가 필요하다. 이걸 데이지체인으로 연결해야 한다.

데이지체인이 뭐냐면, IC들을 직렬로 연결해서 하나의 SPI 버스로 통신하는 방식이다. MCU 입장에서는 IC가 몇 개든 SPI 핀 하나로 다 제어할 수 있다.

---

연결 구조는 이렇다.

```
배터리 팩 (72V)
    │
    ├─ Cell 24 ─┐
    ├─ Cell 23  │
    ├─ Cell 22  ├─ AD7280A #3 (맨 위)
    ├─ Cell 21  │
    ├─ Cell 20  │
    ├─ Cell 19 ─┘
    │           ↑↓ SDI/SDO
    ├─ Cell 18 ─┐
    ├─ Cell 17  │
    ├─ Cell 16  ├─ AD7280A #2
    ├─ Cell 15  │
    ├─ Cell 14  │
    ├─ Cell 13 ─┘
    │           ↑↓ SDI/SDO
    ├─ Cell 12 ─┐
    ├─ Cell 11  │
    ├─ Cell 10  ├─ AD7280A #1
    ├─ Cell 9   │
    ├─ Cell 8   │
    ├─ Cell 7  ─┘
    │           ↑↓ SDI/SDO
    ├─ Cell 6  ─┐
    ├─ Cell 5   │
    ├─ Cell 4   ├─ AD7280A #0 (맨 아래)
    ├─ Cell 3   │
    ├─ Cell 2   │
    ├─ Cell 1  ─┘
    │           ↑↓ SPI
   GND ──────── MCU (STM32)
```

MCU는 맨 아래 #0하고만 직접 통신한다. 명령을 보내면 #0 → #1 → #2 → #3 순서로 올라가고, 응답은 반대로 내려온다.

---

여기서 주의할 점이 있다.

각 IC의 전원 기준이 다르다. #0은 GND 기준이지만, #3은 Cell 18 전압(약 54V)이 기준이다. 그래서 IC 간 통신 신호도 레벨이 다르다.

AD7280A 내부에 레벨 시프터가 있어서 자동으로 변환해준다고 하는데, 실제로 해보니까 배선 길이나 노이즈에 민감했다.

---

데이지체인 통신이 동작하려면 몇 가지 설정이 필요하다.

1. 각 IC에 고유 주소 할당 (자동 또는 수동)
2. 체인 내 IC 개수 설정
3. 통신 타이밍 설정

처음에 이 설정을 안 하고 그냥 통신 시도했다가 응답이 안 와서 한참 헤맸다. 데이터시트를 꼼꼼히 읽어야 한다.

---

실제 셀 연결은 이렇게 했다.

![셀 탭 연결](/imgs/cells%20connection.jpg)

셀 탭 선이 엄청 많다. 24셀이면 탭이 25개(셀 사이사이 + 맨 위아래). 여기에 온도 센서 선까지 더하면 배선 정리가 일이다.

---

다음 글에서 STM32 SPI 설정하고 실제 통신 시도한다.

[#3 - SPI 통신 시작](/posts/bms/ad7280a-bms-dev-3/)
