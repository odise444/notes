---
title: "AD7280A BMS 개발기 번외 #2 - Linux 드라이버 코드 읽기"
date: 2024-12-15
draft: false
tags: ["AD7280A", "BMS", "Linux", "커널", "드라이버"]
categories: ["BMS 개발"]
series: ["AD7280A BMS 개발"]
summary: "삽질하다 지쳐서 커널 코드를 열어봤다. 내가 3주 걸린 걸 200줄로 해놨더라."
---

CRC 때문에 3일 날리고, 통신 프레임 때문에 또 3일 날리고.

"나만 이렇게 힘든가?" 싶어서 검색해봤다. Linux 커널에 AD7280A 드라이버가 있었다.

```
drivers/iio/adc/ad7280a.c
```

2011년에 작성됐다. 내가 고등학생일 때.

---

CRC 구현을 봤다.

나는 비트 단위로 매번 계산했는데, 커널은 룩업 테이블을 썼다.

```c
static void ad7280_crc8_build_table(unsigned char *crc_tab)
{
    // 초기화할 때 테이블 생성
    // 이후 O(1)로 CRC 계산
}
```

성능도 좋고 디버깅도 쉽다. 왜 처음부터 이렇게 안 했을까.

---

읽기 방식도 달랐다.

나는 셀 하나씩 읽었다. 커널은 버스트 모드로 한 번에 다 읽었다.

```
내 방식: 24번 SPI 트랜잭션, 약 50ms
커널 방식: 1+24번 SPI 트랜잭션, 약 5ms
```

10배 빠르다.

---

배운 것들:
- CRC는 룩업 테이블
- 버스트 읽기 활용
- 매크로로 비트필드 정의
- 에러 처리 꼼꼼히

커널 코드를 먼저 봤으면 2주는 아꼈다.

---

다음 글에서 중국산 BMS IC를 비교한다.

[B3 - 중국산 BMS IC](/posts/bms/ad7280a-bms-dev-b3/)
