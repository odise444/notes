---
title: "AD7280A BMS 개발 삽질기 번외 #4 - 14S NMC에서 24S LFP로"
date: 2024-12-15
draft: false
tags: ["AD7280A", "BMS", "NMC", "LFP", "배터리", "마이그레이션"]
categories: ["BMS 개발"]
series: ["AD7280A BMS 개발"]
summary: "기존 14S NMC용 BMS를 24S LFP로 바꿔달라는 요청. '셀 수만 바꾸면 되는 거 아냐?' 아니었다."
---

## 전화 한 통

2024년 초, 영업팀에서 전화가 왔다.

**"기존 BMS 있잖아요, 그거 LFP 버전으로 만들 수 있어요?"**

기존 제품은 14S NMC (51.8V)용. 새 요청은 24S LFP (76.8V)용.

"셀 수만 바꾸면 되는 거 아닌가요?"

**"어... 그게..."**

설명하려다 관뒀다. 직접 해보면 알겠지.

---

## NMC vs LFP 차이

겉보기엔 둘 다 리튬 배터리다. 하지만 특성이 완전히 다르다.

```
┌───────────────────────────────────────────────────────┐
│  항목         │ NMC (기존)      │ LFP (신규)        │
├───────────────┼─────────────────┼───────────────────┤
│  공칭 전압    │ 3.7V/셀         │ 3.2V/셀          │
│  만충 전압    │ 4.2V            │ 3.65V            │
│  방전 종지    │ 3.0V            │ 2.5V             │
│  동작 범위    │ 3.0~4.2V        │ 2.5~3.65V        │
│  OCV 커브     │ 가파름          │ 평평함 (!)       │
│  에너지 밀도  │ 높음            │ 낮음             │
│  안전성       │ 보통            │ 높음             │
│  수명         │ 1000 사이클     │ 3000+ 사이클     │
└───────────────────────────────────────────────────────┘
```

**문제 1: 전압 범위가 다르다**

```
14S NMC:
- 만충: 4.2V × 14 = 58.8V
- 방전: 3.0V × 14 = 42.0V
- 범위: 42~59V

24S LFP:
- 만충: 3.65V × 24 = 87.6V
- 방전: 2.5V × 24 = 60.0V
- 범위: 60~88V
```

**회로 전체가 더 높은 전압을 버텨야 한다.**

---

## 첫 번째 삽질: 부품 교체 지옥

72V 시스템을 88V까지 올리니 부품들이 터지기 시작했다.

**터진 부품 1: MOSFET**

```
기존 설계:
- 보호 MOSFET: 80V 정격
- 실사용: 최대 60V
- 마진: 20V (33%)

신규 요구:
- 시스템 전압: 88V
- 필요 정격: 최소 120V
```

80V MOSFET에 88V가 걸리면? **펑!**

**터진 부품 2: 전해 커패시터**

```
기존: 63V 정격
신규 필요: 100V 정격
```

**터진 부품 3: DC-DC 컨버터**

```
기존: 입력 60V max
신규: 입력 88V → 사용 불가
```

**BOM 절반을 갈아엎었다:**

| 부품 | 기존 | 신규 |
|------|------|------|
| 메인 MOSFET | 80V | 150V |
| 프리차지 MOSFET | 60V | 120V |
| 전해 캡 | 63V | 100V |
| 세라믹 캡 | 50V | 100V |
| DC-DC | 60V | 100V |
| TVS | 70V | 100V |

---

## 두 번째 삽질: AD7280A 설정 변경

AD7280A는 셀 전압 범위에 따라 설정을 바꿔야 한다.

**과전압/저전압 임계값:**

```c
// NMC 설정 (기존)
#define OV_THRESHOLD_MV     4250    // 4.25V (4.2V + 마진)
#define UV_THRESHOLD_MV     2900    // 2.9V (3.0V - 마진)

// LFP 설정 (신규)
#define OV_THRESHOLD_MV     3700    // 3.7V (3.65V + 마진)
#define UV_THRESHOLD_MV     2400    // 2.4V (2.5V - 마진)
```

레지스터 값으로 변환:

```c
// AD7280A OV/UV 레지스터
// 값 = (전압 - 1V) / 6mV

// NMC
uint8_t ov_reg = (4250 - 1000) / 6;  // = 541 → 0xFF (saturate)
uint8_t uv_reg = (2900 - 1000) / 6;  // = 316 → 0x13C

// LFP
uint8_t ov_reg = (3700 - 1000) / 6;  // = 450 → 0x1C2
uint8_t uv_reg = (2400 - 1000) / 6;  // = 233 → 0x0E9
```

---

## 세 번째 삽질: SOC 추정 완전 재작업

이게 진짜 문제였다.

**NMC의 OCV 커브:**

```
전압 (V)
4.2 │        ╭────
    │      ╭─╯
4.0 │    ╭─╯
    │  ╭─╯
3.6 │╭─╯
    │╯
3.0 └────────────────
    0   20  40  60  80  100 (%)
    
→ 전압만 봐도 SOC를 대충 알 수 있다
```

**LFP의 OCV 커브:**

```
전압 (V)
3.65│        ╭────
    │────────╯
3.3 │
    │
3.2 │────────────────
    │
2.5 │╰────
    └────────────────
    0   20  40  60  80  100 (%)
    
→ 20~80% 구간이 평평해서 전압으로 SOC를 모른다!
```

**기존 하이브리드 SOC 방식이 안 먹혔다.**

```c
// 기존 (NMC): OCV 보정 자주 함
void SOC_UpdateHybrid(float measured_v, float current) {
    // 쿨롱 카운팅
    soc_coulomb += current * dt / capacity_ah;
    
    // OCV 보정 (전류 작을 때)
    if (fabsf(current) < 0.5f) {
        float soc_ocv = OCV_LookupSOC(measured_v);  // 이게 잘 됨
        soc = soc * 0.9f + soc_ocv * 0.1f;  // 블렌딩
    }
}

// LFP에서는...
float soc_ocv = OCV_LookupSOC(measured_v);
// measured_v = 3.28V
// → 테이블에서 찾으면 SOC가 25%? 30%? 50%? 전부 비슷!
```

**LFP용 SOC 추정은 쿨롱 카운팅에 더 의존해야 한다.**

```c
// LFP용 SOC
void SOC_UpdateLFP(float measured_v, float current) {
    // 쿨롱 카운팅 (주력)
    soc_coulomb += current * dt / capacity_ah;
    
    // OCV 보정 (양 끝에서만!)
    if (fabsf(current) < 0.5f) {
        if (measured_v > 3.55f) {
            // 90% 이상 구간 - OCV 신뢰 가능
            float soc_ocv = OCV_LookupSOC(measured_v);
            soc = soc * 0.7f + soc_ocv * 0.3f;
        } else if (measured_v < 2.8f) {
            // 10% 이하 구간 - OCV 신뢰 가능
            float soc_ocv = OCV_LookupSOC(measured_v);
            soc = soc * 0.7f + soc_ocv * 0.3f;
        }
        // 그 외 구간은 쿨롱 카운팅만 믿는다
    }
    
    soc = soc_coulomb;  // 쿨롱 카운팅 기반
}
```

---

## 네 번째 삽질: OCV 테이블 새로 만들기

LFP용 OCV 테이블이 필요했다. 직접 측정해야 했다.

**측정 방법:**

```
1. 완충 (3.65V까지)
2. 1시간 안정화
3. 0.05C로 조금 방전
4. 1시간 안정화
5. 전압 측정, 방전량 기록
6. 3~5 반복 (0%까지)
```

**총 소요 시간:** 24시간 × 3회 = 72시간 (3일)

**결과 테이블:**

```c
// LFP OCV 테이블 (실측)
const float lfp_ocv_table[101] = {
    // SOC 0% ~ 10%
    2.50, 2.85, 2.92, 2.96, 2.99, 3.02, 3.05, 3.08, 3.10, 3.12, 3.14,
    // SOC 11% ~ 20%
    3.16, 3.18, 3.19, 3.20, 3.21, 3.22, 3.23, 3.24, 3.25, 3.26, 3.27,
    // SOC 21% ~ 80% (평평한 구간)
    3.27, 3.27, 3.28, 3.28, 3.28, 3.28, 3.28, 3.29, 3.29, 3.29,
    3.29, 3.29, 3.29, 3.30, 3.30, 3.30, 3.30, 3.30, 3.30, 3.30,
    3.30, 3.30, 3.30, 3.30, 3.31, 3.31, 3.31, 3.31, 3.31, 3.31,
    3.31, 3.31, 3.31, 3.31, 3.31, 3.32, 3.32, 3.32, 3.32, 3.32,
    // SOC 81% ~ 90%
    3.32, 3.33, 3.34, 3.35, 3.36, 3.38, 3.40, 3.42, 3.45, 3.48,
    // SOC 91% ~ 100%
    3.50, 3.52, 3.54, 3.56, 3.58, 3.60, 3.62, 3.63, 3.64, 3.65
};

// 보시다시피 20~80% 구간은 거의 변화가 없다
// 3.27V ~ 3.32V 사이에 60%가 몰려있다!
```

---

## 다섯 번째 삽질: 밸런싱 전략 변경

NMC와 LFP는 밸런싱 접근이 달라야 한다.

**NMC:**

```
셀 간 편차: 30mV → SOC 편차 약 5%
→ 적극적 밸런싱 필요
→ 항상 모니터링, 즉시 밸런싱
```

**LFP:**

```
셀 간 편차: 30mV → SOC 편차 약 0.5~30% (구간에 따라 다름)
평평한 구간: 30mV 차이 = 거의 의미 없음
양 끝 구간: 30mV 차이 = 심각할 수 있음
```

**LFP 밸런싱 전략:**

```c
void LFP_BalancingStrategy(void) {
    float min_v = GetMinCellVoltage();
    float max_v = GetMaxCellVoltage();
    float delta = max_v - min_v;
    
    // 평평한 구간 (3.15V ~ 3.45V)
    if (min_v > 3.15f && max_v < 3.45f) {
        // 전압 차이가 커도 SOC 차이는 작음
        // 밸런싱 임계값을 높게
        if (delta > 50) {  // 50mV 이상만
            DoBalancing();
        }
    }
    // 양 끝 구간
    else {
        // 전압 차이 = SOC 차이
        // 밸런싱 임계값을 낮게
        if (delta > 20) {  // 20mV 이상
            DoBalancing();
        }
    }
    
    // 충전 막판 (3.5V 이상)
    if (max_v > 3.5f) {
        // 최대 전압 셀 적극 방전
        // 모든 셀이 3.65V에 도달하도록
        AggressiveBalancing();
    }
}
```

---

## 여섯 번째 삽질: 충전 알고리즘

NMC는 CC-CV 충전이 표준이다.

```
NMC 충전:
전류│    CC 구간     │ CV 구간
    │────────────────┤
1C  │■■■■■■■■■■■■■■│
    │               │╲
    │               │ ╲
    │               │  ╲
    └───────────────┴────────
                   4.2V
```

LFP는 CV 구간이 거의 없다.

```
LFP 충전:
전류│    CC 구간     
    │────────────────────┐
1C  │■■■■■■■■■■■■■■■■■■│← 거의 여기서 끝
    │                    │
    │                    │
    │                    │
    └────────────────────┴
                      3.65V
```

**LFP는 CC 충전만으로도 95%까지 간다.** CV 구간이 매우 짧다.

```c
// LFP 충전 종료 조건
bool LFP_IsChargingComplete(void) {
    float max_cell = GetMaxCellVoltage();
    float current = GetChargingCurrent();
    
    // 조건 1: 최대 전압 도달
    if (max_cell >= 3.65f) {
        return true;
    }
    
    // 조건 2: CV 구간에서 전류 감소 (짧음)
    if (max_cell >= 3.60f && current < 0.05f * capacity_ah) {
        return true;
    }
    
    return false;
}
```

---

## 최종 변경 사항 정리

```
14S NMC → 24S LFP 변환 작업 목록:
┌─────────────────────────────────────────────────────────┐
│  [하드웨어]                                             │
│  □ 전압 정격 부품 전체 교체 (80V→150V)                 │
│  □ AD7280A 4개로 확장 (기존 3개)                       │
│  □ PCB 재설계 (고전압 이격)                            │
│  □ 커넥터 정격 확인                                    │
│                                                         │
│  [펌웨어 - 기본]                                        │
│  □ OV/UV 임계값 변경                                   │
│  □ OCV 테이블 교체                                     │
│  □ 셀 수 설정 변경 (14→24)                            │
│                                                         │
│  [펌웨어 - SOC]                                         │
│  □ SOC 추정 알고리즘 재작성                            │
│  □ OCV 보정 로직 수정                                  │
│  □ 쿨롱 카운팅 의존도 증가                             │
│                                                         │
│  [펌웨어 - 밸런싱]                                      │
│  □ 밸런싱 임계값 구간별 차등                           │
│  □ 충전 말기 적극 밸런싱                               │
│                                                         │
│  [펌웨어 - 충전]                                        │
│  □ 충전 종료 조건 수정                                 │
│  □ CV 구간 처리 수정                                   │
│                                                         │
│  [테스트]                                               │
│  □ SOC 정확도 검증 (1 사이클)                          │
│  □ 밸런싱 동작 검증                                    │
│  □ 보호 기능 검증                                      │
│  □ 장기 사이클 테스트                                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**예상 기간: 1주일**
**실제 소요: 2개월**

---

## 교훈

**"셀 수만 바꾸면 돼요"가 아니었던 이유:**

1. **전압 범위**: 부품 정격 전부 재검토
2. **화학적 특성**: OCV 커브가 완전히 다름
3. **SOC 추정**: 알고리즘 재설계 필요
4. **밸런싱**: 전략 자체가 달라야 함
5. **충전**: 종료 조건이 다름

```
NMC → LFP 전환 난이도:

"파라미터 몇 개 바꾸기" (예상)
        ↓
"알고리즘 재설계" (현실)
        ↓
"하드웨어까지 재설계" (실제)
```

**결론:**

> 배터리 화학이 다르면 BMS도 다르다.

"비슷하니까 되겠지"는 통하지 않는다.

---

## 시리즈 완결!

```
╔════════════════════════════════════════════════════════════╗
║                                                            ║
║           AD7280A BMS 개발 삽질기 완결!                    ║
║                                                            ║
╠════════════════════════════════════════════════════════════╣
║                                                            ║
║  Part 1: 기초편           (3개)                            ║
║  Part 2: 드라이버편        (3개)                            ║
║  Part 3: 측정편           (3개)                            ║
║  Part 4: 밸런싱편         (3개)                            ║
║  Part 5: 알람 & 보호편     (4개)                            ║
║  Part 6: 통신 & 진단편     (4개)                            ║
║  Part 7: 고급 기능편       (4개)                            ║
║  Part 8: 실전 적용편       (4개)                            ║
║  Part 9: 하드웨어 설계편   (4개)                            ║
║  번외편                   (4개)                            ║
║                                                            ║
║  총 36개 글                                                ║
║                                                            ║
╚════════════════════════════════════════════════════════════╝
```

지금까지 읽어주셔서 감사합니다!

---

## 시리즈 네비게이션

**번외편** ✅
- [B1 - AD7280A 단종 이야기](/posts/bms/ad7280a-bms-dev-b1/)
- [B2 - Linux IIO 드라이버 분석](/posts/bms/ad7280a-bms-dev-b2/)
- [B3 - 중국산 BMS IC 비교](/posts/bms/ad7280a-bms-dev-b3/)
- **B4 - 14S→24S 변환기** ← 현재 글 (완결)

---

## 전체 시리즈 목차

- [Part 1: 기초편](/posts/bms/ad7280a-bms-dev-1/)
- [Part 2: 드라이버편](/posts/bms/ad7280a-bms-dev-4/)
- [Part 3: 측정편](/posts/bms/ad7280a-bms-dev-7/)
- [Part 4: 밸런싱편](/posts/bms/ad7280a-bms-dev-10/)
- [Part 5: 알람 & 보호편](/posts/bms/ad7280a-bms-dev-13/)
- [Part 6: 통신 & 진단편](/posts/bms/ad7280a-bms-dev-17/)
- [Part 7: 고급 기능편](/posts/bms/ad7280a-bms-dev-21/)
- [Part 8: 실전 적용편](/posts/bms/ad7280a-bms-dev-25/)
- [Part 9: 하드웨어 설계편](/posts/bms/ad7280a-bms-dev-29/)
- [번외편](/posts/bms/ad7280a-bms-dev-b1/)

---

## 참고 자료

- [LiFePO4 vs NMC Comparison](https://batteryuniversity.com/article/bu-205-types-of-lithium-ion)
- [LFP SOC Estimation Challenges](https://www.mdpi.com/1996-1073/14/19/6364)
- [Battery Chemistry Guide](https://www.epectec.com/batteries/chemistry/)
