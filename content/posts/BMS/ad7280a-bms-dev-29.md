---
title: "AD7280A BMS 개발 삽질기 #29 - 회로도 설계, 그 치열했던 일주일"
date: 2024-12-14
draft: false
tags: ["AD7280A", "BMS", "STM32", "회로설계", "데이터시트", "하드웨어"]
categories: ["BMS 개발"]
series: ["AD7280A BMS 개발"]
summary: "데이터시트 Figure 29만 보고 회로 그리면 되는 줄 알았다. 그게 아니었다."
---

## 시작은 자신만만했다

2023년 3월, 팀장님이 말했다.

"AD7280A로 24셀 BMS 만들어봐. 한 달이면 되지?"

데이터시트를 훑어봤다. Figure 29에 레퍼런스 회로가 떡하니 있었다. '이거 그대로 그리면 되겠네.' 일주일이면 충분할 것 같았다.

그로부터 3주 동안 퇴근을 제대로 못 했다.

---

## 첫 번째 삽질: 레퍼런스 회로의 함정

Figure 29를 OrCAD에 그대로 옮겼다. 뿌듯했다. 그런데 시뮬레이션을 돌려보니 이상했다.

**"왜 Cell 1 전압이 음수지?"**

한참을 들여다봤다. 데이터시트를 다시 읽었다. 그제야 보였다.

> "Note: This circuit shows a single device. For multiple devices, refer to daisy-chain configuration."

Figure 29는 **1개 디바이스**용이었다. 나는 4개를 데이지체인으로 연결해야 했다. 처음부터 다시.

---

## 두 번째 삽질: 전압 레벨의 미스터리

4개 디바이스 데이지체인 회로를 그렸다. 이번엔 제대로 했다고 생각했다.

PCB 제작하고 납땜하고 전원 넣었다. **통신이 안 됐다.**

오실로스코프로 SPI 파형을 봤다.

```
MCU 출력 (3.3V 레벨):
     ┌──┐  ┌──┐  ┌──┐
─────┘  └──┘  └──┘  └─── 3.3V
                        0V

AD7280A가 받은 신호:
     ┌─┐   ┌─┐   ┌─┐
─────┘ └───┘ └───┘ └──── 1.8V?!
                        0V
```

전압이 반토막 나 있었다. 왜?

**레벨 시프터를 빼먹었다.**

AD7280A의 디지털 I/O는 VDD 기준이다. VDD가 5V면 5V 로직이 필요하다. 3.3V MCU랑 직접 연결하면 안 됐다.

데이터시트 어디에도 크게 안 써있었다. 아니, 써있긴 했다. 작은 글씨로.

> "Digital inputs are referenced to DVDD."

이 한 줄을 놓쳤다.

---

## 세 번째 삽질: 72V를 견디는 부품

레벨 시프터 추가하고 다시 PCB. 이번엔 통신이 됐다! 기뻤다.

**전원 공급기에서 72V 올리는 순간, '퍽' 소리와 함께 연기가 났다.**

입력 커패시터가 터졌다. 정격 25V짜리를 달았던 것이다.

```
내가 한 실수:
┌─────────────────────────────────────────┐
│  72V 라인에 25V 커패시터                 │
│                                         │
│     72V ──┬── 💥 (C1: 25V) ── GND       │
│           │                             │
│           └── 정상 동작할 리가 없다      │
└─────────────────────────────────────────┘
```

부품 선정할 때 전압 정격을 제대로 안 봤다. BOM 전체를 다시 검토했다. 100V 정격 부품으로 교체.

PCB 3번째 주문.

---

## 네 번째 삽질: 입력 저항의 비밀

새 PCB, 새 부품. 이번엔 터지지 않았다. 통신도 됐다. 셀 전압도 읽혔다.

**근데 값이 이상했다.**

```
실제 전압:  3.200V, 3.200V, 3.200V, ...
측정 전압:  3.185V, 3.201V, 3.178V, ...
오차:       15mV,   1mV,    22mV,   ...
```

어떤 셀은 정확하고, 어떤 셀은 20mV 넘게 틀렸다. 패턴이 없었다.

열흘을 헤맸다. 인터넷 검색, 포럼 질문, 데이터시트 정독. 답이 안 나왔다.

**그러다 EngineerZone 게시판에서 실마리를 찾았다:**

> "The input resistance should be matched for all cells to minimize offset error."

아, 입력 저항.

AD7280A 셀 입력단에 있는 필터 저항을 전부 다른 값으로 달았었다. 부품함에 있는 거 아무거나 집어서. 1kΩ, 1.2kΩ, 1.5kΩ 섞어서.

**전부 같은 값(1kΩ, 1% 정밀도)으로 교체하니 오차가 5mV 이내로 줄었다.**

---

## 다섯 번째 삽질: 밸런싱 저항의 화상

셀 전압 정확도 문제 해결. 이제 밸런싱 테스트.

밸런싱 ON. 전류가 잘 흐른다. 신났다.

**5분 후, 손가락이 화끈거렸다.**

밸런싱 저항을 만졌는데 100°C가 넘었다. 0603 사이즈에 1/10W 저항을 달았는데, 실제로는 0.5W가 소모되고 있었다.

```
전력 계산을 안 했던 것이다:

P = V² / R = 3.3² / 33 = 0.33W

0603 (1/10W) 저항에 0.33W?
→ 정격의 3배 → 과열 → 화상
```

1206 사이즈 1/4W 저항으로 교체. 그래도 뜨거워서 결국 2512 사이즈 1W로.

PCB 4번째 주문.

---

## 여섯 번째 삽질: 데이지체인 연결 순서

4번째 PCB. 이번엔 제대로 될 것 같았다.

디바이스 0, 1은 잘 읽힌다. **디바이스 2, 3이 응답이 없다.**

배선을 확인했다. 멀쩡했다. 납땜도 깨끗했다.

이틀을 또 헤맸다.

**문제는 전원 시퀀싱이었다.**

데이지체인에서 각 디바이스는 아래쪽(저전위) 디바이스가 먼저 켜져야 한다. 나는 모든 디바이스에 동시에 전원을 넣고 있었다.

```
잘못된 시퀀스:          올바른 시퀀스:
                        
Dev0 ─ON─              Dev0 ─ON─────────
Dev1 ─ON─ (동시)       Dev1 ────ON──────
Dev2 ─ON─              Dev2 ───────ON───
Dev3 ─ON─              Dev3 ──────────ON
     │                      │
     ▼                      ▼
   혼란                   정상 부팅
```

데이터시트 깊숙이 숨어있던 한 문장:

> "Apply power to the lowest potential device first."

전원 시퀀서 IC를 추가하거나, 소프트웨어로 순차 활성화해야 했다.

---

## 일곱 번째 삽질: 그라운드의 중요성

시퀀싱 문제 해결. 4개 디바이스 모두 통신 성공!

**그런데 노이즈가 심했다.** 모터 돌리면 셀 전압이 ±50mV씩 흔들렸다.

```
모터 OFF:  3200mV, 3201mV, 3199mV ...
모터 ON:   3150mV, 3248mV, 3167mV ... (난리)
```

페라이트 추가, 커패시터 추가, 별 짓 다 해봤다. 효과 없었다.

**선배가 PCB를 보더니 한마디 했다.**

"야, GND 비아가 왜 이렇게 적어?"

봤더니 GND 플레인에 비아가 듬성듬성. IC 바로 밑에는 비아가 하나도 없었다.

"GND는 인덕턴스야. 비아 많이 박아서 임피던스 낮춰야 해."

IC 밑에 비아를 빽빽하게 추가했다. 노이즈가 ±10mV로 줄었다.

PCB 5번째 주문.

---

## 드디어 완성

5번째 PCB에서 모든 게 돌아갔다.

- 셀 전압: 오차 ±5mV 이내
- 밸런싱: 정상 동작, 발열 적정
- 데이지체인: 4개 디바이스 안정적
- 노이즈: 모터 구동 중에도 ±10mV

**한 달 예상이 석 달 걸렸다.** PCB만 5번 갈아엎었다.

---

## 그때 알았더라면

회로도 그리기 전에 체크했어야 할 것들:

```
┌─────────────────────────────────────────┐
│  □ 레퍼런스 회로가 내 구성과 맞는가?    │
│    (디바이스 개수, 데이지체인 여부)      │
│                                         │
│  □ 전압 레벨 인터페이스 확인했는가?     │
│    (MCU ↔ IC 간 레벨 시프터 필요?)      │
│                                         │
│  □ 모든 부품의 전압 정격 확인했는가?    │
│    (시스템 최대 전압의 1.5배 이상)       │
│                                         │
│  □ 매칭이 필요한 부품 파악했는가?       │
│    (입력 저항, 분압 저항 등)             │
│                                         │
│  □ 발열 계산 했는가?                    │
│    (밸런싱 저항, 션트 저항 등)           │
│                                         │
│  □ 전원 시퀀싱 요구사항 확인했는가?     │
│                                         │
│  □ GND 설계 전략 세웠는가?              │
│    (플레인, 비아 배치)                   │
└─────────────────────────────────────────┘
```

---

## 정리: 회로도에서 놓치기 쉬운 것들

| 삽질 | 원인 | 교훈 |
|------|------|------|
| 레퍼런스 회로 맹신 | 단일 디바이스용 | 내 구성에 맞게 수정 |
| 통신 안 됨 | 레벨 시프터 누락 | DVDD 전압 확인 |
| 커패시터 폭발 | 전압 정격 미확인 | 정격 = 실사용 × 1.5 |
| 측정 오차 | 입력 저항 불일치 | 1% 정밀 저항 사용 |
| 저항 과열 | 전력 계산 안 함 | P = V²/R 꼭 계산 |
| 일부 디바이스 인식 불가 | 전원 시퀀싱 | 낮은 전위부터 순차 |
| 노이즈 | GND 비아 부족 | IC 밑에 비아 빽빽하게 |

**다음 글에서**: PCB 레이아웃에서 겪은 삽질들. Kelvin 연결을 몰라서 생긴 일.

---

## 시리즈 네비게이션

**Part 9: 하드웨어 설계편**
- **#29 - 회로도 설계** ← 현재 글
- #30 - PCB 레이아웃
- #31 - 부품 선정
- #32 - 제작 및 조립

---

## 참고 자료

- [AD7280A Datasheet - Figure 29](https://www.analog.com/media/en/technical-documentation/data-sheets/ad7280a.pdf)
- [EngineerZone AD7280A Forum](https://ez.analog.com/data_converters/precision_adcs/w/documents/2572/ad7280a-faq)
- [Analog Devices CN0197](https://www.analog.com/en/resources/reference-designs/circuits-from-the-lab/cn0197.html)
