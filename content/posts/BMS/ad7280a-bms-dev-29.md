---
title: "AD7280A BMS 개발기 #29 - 회로도 그리다가 머리 깨진 이야기"
date: 2024-12-14
draft: false
tags: ["AD7280A", "BMS", "STM32", "회로설계", "하드웨어"]
categories: ["BMS 개발"]
series: ["AD7280A BMS 개발"]
summary: "Figure 29 보고 따라 그리면 끝인 줄 알았는데요. 아니었어요."
---

3월 둘째 주 월요일이었나. 팀장님이 자리로 오셔서 "AD7280A로 24셀 BMS 만들어봐"라고 하셨다. 데이터시트 대충 넘겨보니까 Figure 29에 레퍼런스 회로가 있길래, 아 이거 일주일이면 되겠다 싶었다.

결론부터 말하면 석 달 걸렸다. PCB 5번 새로 뽑았다.

---

아래 사진은 두 번째 PCB인데, 이때만 해도 뭐가 문제인지 몰랐다.

{{< figure src="/images/bms/pcb-rev2.jpg" caption="Rev 2.0 - 이때는 희망이 있었다" >}}

첫 번째 삽질은 Figure 29가 **단일 디바이스**용이라는 거였다. 나는 4개를 붙여야 하는데 그림 밑에 작은 글씨로 "For multiple devices, refer to daisy-chain configuration"이라고 써있더라. 이걸 왜 이렇게 작게 써놨는지.

데이지체인 구성으로 다시 그렸다.

---

두 번째로 막힌 건 레벨 시프터였다. STM32가 3.3V인데 AD7280A는 VDD 기준이라 5V 로직이다. 이걸 직결했더니 통신이 안 됐다.

오실로로 찍어보니까 3.3V 신호가 IC 입력단에서 1.8V 정도로 보였다. 분명 선 연결은 됐는데 왜 전압이 반토막 나지? 한참 헤매다가 EngineerZone 뒤져서 답을 찾았다. 데이터시트 어딘가에 "Digital inputs are referenced to DVDD"라고 써있었는데 이걸 놓쳤다.

```
MCU(3.3V) --[레벨시프터]--> AD7280A(5V)
```

지금 보면 당연한 건데 그때는 왜 몰랐을까.

---

세 번째는 커패시터 터진 거다.

{{< figure src="/images/bms/cap-exploded.jpg" caption="25V 캡에 72V 넣으면 이렇게 된다" >}}

72V 라인에 25V짜리 전해캡을 달았다. 전원 넣자마자 '퍽' 소리 나면서 터졌다. 부품 선정할 때 정격 전압을 제대로 안 봤다. 사실 이건 변명의 여지가 없는 실수다.

100V짜리로 바꾸고 BOM 전체를 다시 검토했다. 이때 PCB 3번째 주문.

---

네 번째는 아직도 좀 찜찜한 부분인데, 입력 저항 문제다.

셀 전압이 어떤 건 정확하고 어떤 건 15~20mV씩 틀렸다. 패턴도 없었다. 열흘 넘게 헤맸다. 결국 EngineerZone에서 힌트를 얻었는데, 입력 저항이 매칭이 안 되면 오프셋 에러가 생긴다고 한다.

내가 부품함에서 아무 저항이나 집어서 달았는데, 측정해보니 1kΩ, 1.2kΩ, 1.5kΩ 섞여있었다. 전부 1% 정밀 저항으로 바꾸니까 오차가 5mV 이내로 줄었다.

근데 왜 저항 값이 다르면 오차가 생기는지 원리는 솔직히 아직 100% 이해 못 했다. 샘플링 커패시터 충전 시간이랑 관련 있다는 것 같은데, 누가 아시면 댓글 좀.

---

다섯 번째, 밸런싱 저항.

0603 사이즈 1/10W 저항을 달았는데 전력 계산을 안 했다. P = V²/R = 3.3²/33 = 0.33W. 정격의 3배가 걸렸다. 5분 만에 손 못 댈 정도로 뜨거워졌다.

{{< figure src="/images/bms/hot-resistor.jpg" caption="열화상으로 찍은 밸런싱 저항 (대략 이런 느낌이었다)" >}}

2512 사이즈 1W로 바꿨다. 이것 때문에 풋프린트 다 바뀌어서 PCB 4번째 주문.

---

여섯 번째, 데이지체인 시퀀싱.

4개 디바이스 중 앞에 2개만 인식되고 뒤에 2개가 응답이 없었다. 배선 확인하고 납땜 다시 하고 별짓 다 해봤는데 안 됐다.

이틀 후에 데이터시트 다시 읽다가 발견했다. "Apply power to the lowest potential device first." 아래쪽 디바이스부터 전원이 들어가야 한다는 거다. 나는 동시에 넣고 있었다.

전원 시퀀서를 추가할까 하다가 그냥 소프트웨어로 처리했다. 전원 인가 후 딜레이 넣어가면서 순차적으로 활성화.

---

일곱 번째, GND 비아.

모터 돌리면 셀 전압이 ±50mV씩 흔들렸다. 페라이트 달고 캡 추가하고 해봤는데 효과가 없었다.

결국 K선배한테 보여줬더니 PCB 보자마자 "GND 비아가 너무 적다"고 하셨다. IC 바로 밑에 비아를 빽빽하게 추가하니까 노이즈가 ±10mV로 줄었다.

PCB 5번째 주문. 이때가 5월 말이었다.

---

6월 초에 드디어 제대로 돌아갔다. 

{{< figure src="/images/bms/working-board.jpg" caption="Rev 5.0 - 드디어 된다" >}}

셀 전압 오차 ±5mV 이내, 밸런싱 정상, 데이지체인 4개 다 인식, 모터 돌려도 노이즈 ±10mV.

3월에 일주일이면 된다고 했던 게 6월이 되어서야 끝났다.

---

## 그때 알았으면 좋았을 것들

- Figure 29는 싱글 디바이스용이다. 멀티는 따로 봐야 함
- 3.3V MCU랑 5V IC 연결할 때 레벨 시프터 확인
- 72V 시스템이면 부품 정격 100V 이상으로
- 아날로그 입력 저항은 1% 매칭
- 발열 부품은 전력 계산 먼저 (P=V²/R)
- 데이지체인은 전원 시퀀싱 주의
- GND 플레인에 비아 많이 박기

솔직히 이것들 다 데이터시트에 써있긴 하다. 근데 600페이지 문서에서 저 한 줄들을 찾아내는 게 일이다.

---

다음 글에서는 PCB 레이아웃 얘기. Kelvin 연결이 뭔지 몰라서 전류 측정 30%씩 틀렸던 이야기.

[#30 - PCB 레이아웃](/posts/bms/ad7280a-bms-dev-30/)
