---
title: "AD7280A BMS 개발 삽질기 #30 - PCB 레이아웃, 0.3mm의 전쟁"
date: 2024-12-14
draft: false
tags: ["AD7280A", "BMS", "STM32", "PCB", "레이아웃", "고전압"]
categories: ["BMS 개발"]
series: ["AD7280A BMS 개발"]
summary: "회로도는 맞는데 왜 동작을 안 하지? PCB 레이아웃에서 벌어진 눈에 안 보이는 전쟁들."
---

## 회로도 완성, 그 다음

회로도 검증 끝. 시뮬레이션 통과. 이제 PCB만 그리면 된다.

"레이아웃이야 뭐, 부품 배치하고 선 연결하면 되는 거 아냐?"

그렇게 생각했던 내가 바보였다.

---

## 첫 번째 삽질: 고전압 이격 거리

72V 시스템이다. IPC-2221 기준으로 고전압 패턴 간 이격 거리를 계산했다.

```
내부 레이어: 0.25mm/V → 72V면 18mm?!
외부 레이어: 0.1mm/V  → 72V면 7.2mm?!
```

말도 안 됐다. 그렇게 띄우면 PCB가 식탁보만 해진다.

**선배한테 물어봤다.**

"그건 Bare PCB 기준이야. 코팅하면 줄어들어. 그리고 72V면 사실 그렇게 높은 것도 아니야. 1mm 정도면 충분해."

반신반의하며 1mm 이격으로 설계했다. 제작 후 내압 테스트. **500V에서 아크 발생.**

"어? 1mm로 했는데?"

**자세히 보니 솔더 마스크가 벗겨진 부분이 있었다.** 제조 공정에서 생긴 핀홀. 그 0.3mm 구멍으로 아크가 튀었다.

```
설계:                    실제:
                         
─────── 1mm ───────     ─────── 1mm ───────
 패턴A        패턴B       패턴A   💥   패턴B
───────────────────     ────────○──────────
                              ↑
                         솔더마스크 핀홀
                         (아크 발생점)
```

**교훈**: 이론적 이격 거리 + 제조 마진 + 코팅 불량 고려. 1.5mm 이상으로 재설계.

---

## 두 번째 삽질: Kelvin 연결을 몰랐다

전류 센싱용 션트 저항. 10mΩ 저항 양단 전압을 ADC로 읽는다.

```
내가 한 배선:

                 ┌──────────────────┐
    ───┬─────────┤     10mΩ        ├─────────┬───
       │         └──────────────────┘         │
       │                                      │
       └──────── V+ ──────┬────── V- ─────────┘
                          │
                         ADC
```

센스 라인을 전류 경로에서 분기했다. **당연히 그래야 하는 줄 알았다.**

측정 결과가 이상했다. 100A 흘리면 1mV가 나와야 하는데, 1.3mV가 나왔다. 30% 오차.

**"배선 저항이 더해지고 있어."**

```
실제 등가 회로:

           Rwire1        Rshunt        Rwire2
    ──────/\/\/\──────/\/\/\/\──────/\/\/\──────
              │                   │
              │    ← 이 구간 전압을 측정해야 하는데
              │                   │
              └────── V+ ────┬─── V- ───┘
                             │       ↑
                            ADC      │
                                     배선 저항까지 포함됨
```

**Kelvin 연결(4선식 측정)을 해야 했다.**

```
올바른 Kelvin 연결:

           Rwire1        Rshunt        Rwire2
    ──────/\/\/\──────/\/\/\/\──────/\/\/\──────
                    ↑         ↑
                    │         │
              V+ ───┘         └─── V-
                      │   │
                     ─┴───┴─
                       ADC

→ 센스 라인이 션트 저항 패드에서 직접 분기
→ 배선 저항 영향 제거
```

PCB 재설계. 션트 저항 패드에 별도 센스 패드 추가.

---

## 세 번째 삽질: 열이 안 빠진다

밸런싱 저항 24개. 각각 0.3W 발열. 총 7W.

**처음엔 부품을 다닥다닥 붙여놨다.** 공간 절약한다고.

```
처음 배치:
┌─────────────────────────────┐
│ R1 R2 R3 R4 R5 R6 R7 R8 ... │  ← 밀집
│ R9 R10 R11 R12 R13 R14 ...  │
└─────────────────────────────┘
```

테스트 5분 만에 PCB 표면 온도가 85°C를 찍었다. 손도 못 대겠더라.

**열화상 카메라로 찍어봤다.**

가운데 저항들이 빨갛게 타오르고 있었다. 열이 갈 곳이 없었다.

```
수정된 배치:
┌─────────────────────────────────────────┐
│ R1      R3      R5      R7      R9      │
│                                         │
│      R2      R4      R6      R8     R10 │  ← 체커보드
│                                         │
│ R11     R13     R15     R17     R19     │
└─────────────────────────────────────────┘

+ 저항 아래 써멀 비아 추가
+ 뒷면에 GND 구리박으로 방열
```

온도가 65°C로 떨어졌다. 체감 20°C 차이.

---

## 네 번째 삽질: 아날로그와 디지털의 영역 싸움

AD7280A는 아날로그 IC다. 셀 전압이라는 민감한 신호를 다룬다.

**STM32는 디지털이다.** 클럭이 72MHz로 뛴다.

둘을 같은 PCB에 넣으니 문제가 생겼다.

```
ADC 측정값 노이즈:

정상:     3200, 3200, 3201, 3200, 3199, ...
내 보드:  3200, 3215, 3187, 3203, 3221, ...
                ↑           ↑
            스파이크!     스파이크!
```

오실로스코프로 보니 MCU 클럭 타이밍에 정확히 노이즈가 튀었다.

**아날로그 GND와 디지털 GND를 분리 안 했다.**

```
잘못된 GND:

      AD7280A         STM32
         │              │
    ─────┴──────────────┴───── 공통 GND
                    ↑
              여기서 귀환 전류가
              아날로그 측에 영향
```

```
올바른 GND:

      AD7280A              STM32
         │                    │
    ─────┴─── AGND ──┬── DGND ┴─────
                     │
                  한 점 연결
                (Star Ground)
```

4층 PCB로 바꾸고, 아날로그/디지털 영역을 물리적으로 분리했다. 노이즈가 ±3mV로 줄었다.

---

## 다섯 번째 삽질: 데이지체인 신호 무결성

4개 디바이스 데이지체인. SPI 클럭이 1MHz.

**처음엔 대충 연결했다.** "1MHz면 느린 거잖아."

```
처음 배선:
                         
MCU ───────────────────────────────────────┐
           │                               │
     ┌─────┴─────┐                   ┌─────┴─────┐
     │  Dev 0    │                   │  Dev 3    │
     └───────────┘                   └───────────┘
           ↑                               ↑
      배선 5cm                         배선 20cm
```

Dev 0은 잘 되는데 Dev 3 통신이 간헐적으로 실패했다.

파형을 보니 **신호가 찌그러져 있었다.**

```
MCU 출력:            Dev 3에서 받은 신호:
   ┌──┐                 ╭──╮
───┘  └───           ──╯  ╰──
   예쁜 사각파           둥글둥글 + 링잉
```

20cm 배선이 안테나가 되어 신호를 망치고 있었다.

**해결책:**

1. 배선 길이 최소화 (모든 디바이스를 일렬로)
2. 시리즈 저항(33Ω) 추가로 링잉 감소
3. 클럭 속도 500kHz로 낮춤

```
수정된 배선:

MCU ──33Ω──┬── Dev0 ──┬── Dev1 ──┬── Dev2 ──┬── Dev3
           │          │          │          │
          3cm        3cm        3cm        3cm
           ↓          ↓          ↓          ↓
       등간격, 짧은 배선, 직렬 저항
```

---

## 여섯 번째 삽질: 테스트 포인트를 안 넣었다

첫 번째 PCB에는 테스트 포인트가 하나도 없었다.

**"공간 낭비잖아."**

문제가 생기니 측정할 데가 없었다. 매번 IC 핀에 프로브를 대야 했다. 0.5mm 피치 핀에.

```
IC 핀에 프로브 대기:

     ─┬─┬─┬─┬─┬─  ← 0.5mm 간격
      │ │ │ │ │
         ↑
    여기에 프로브?
    손 떨리면 옆 핀 쇼트
```

**한 번은 프로브가 미끄러지면서 두 핀을 쇼트시켰다.** IC가 죽었다. 5만원.

그 뒤로 **모든 중요 신호에 테스트 포인트를 넣었다:**

```
필수 테스트 포인트:
┌─────────────────────────────────────┐
│  TP1: VDD (각 디바이스)             │
│  TP2: DVDD                          │
│  TP3: SPI_CLK                       │
│  TP4: SPI_MOSI                      │
│  TP5: SPI_MISO                      │
│  TP6: ALERT                         │
│  TP7: 셀 전압 (최소 Cell 0, 12, 23) │
│  TP8: 션트 양단                     │
│  TP9: AGND                          │
│  TP10: DGND                         │
└─────────────────────────────────────┘
```

---

## 최종 레이아웃 원칙

5번의 PCB 수정 끝에 정립한 규칙들:

```
┌─────────────────────────────────────────────┐
│             레이아웃 체크리스트              │
├─────────────────────────────────────────────┤
│                                             │
│  [이격 거리]                                │
│  □ 고전압 패턴 간 최소 1.5mm               │
│  □ 고전압-저전압 간 최소 2mm               │
│  □ 솔더 마스크 오픈 영역 추가 이격          │
│                                             │
│  [접지 설계]                                │
│  □ AGND / DGND 분리 후 한 점 연결          │
│  □ GND 비아 IC 밑에 촘촘하게               │
│  □ GND 플레인 분할 최소화                  │
│                                             │
│  [열 관리]                                  │
│  □ 발열 부품 분산 배치                     │
│  □ 써멀 비아 추가                          │
│  □ 방열 구리박 확보                        │
│                                             │
│  [신호 무결성]                              │
│  □ 고속 신호 최단 경로                     │
│  □ 시리즈 종단 저항 고려                   │
│  □ 귀환 경로 확보                          │
│                                             │
│  [측정 용이성]                              │
│  □ 중요 신호에 테스트 포인트               │
│  □ 프로그래밍 헤더                         │
│  □ 디버그 UART 커넥터                      │
│                                             │
│  [정밀 측정]                                │
│  □ 션트 저항 Kelvin 연결                   │
│  □ 기준 전압 필터링                        │
│                                             │
└─────────────────────────────────────────────┘
```

---

## 정리: 레이아웃에서 배운 것들

| 삽질 | 증상 | 원인 | 해결 |
|------|------|------|------|
| 아크 | 내압 테스트 실패 | 이격 거리 부족 | 1.5mm 이상 |
| 전류 오차 | 30% 오차 | 배선 저항 | Kelvin 연결 |
| 과열 | PCB 85°C | 밀집 배치 | 분산 + 써멀 비아 |
| ADC 노이즈 | ±20mV | GND 미분리 | AGND/DGND 분리 |
| 통신 불안정 | 간헐적 실패 | 긴 배선 | 최단 경로 + 직렬 R |
| 디버깅 불가 | 측정점 없음 | TP 미배치 | 모든 주요 신호에 TP |

**가장 큰 교훈**: 회로도가 맞아도 레이아웃이 틀리면 동작 안 한다.

**다음 글에서**: 부품 선정의 함정들. "아무거나 1kΩ" 했다가 생긴 일.

---

## 시리즈 네비게이션

**Part 9: 하드웨어 설계편**
- [#29 - 회로도 설계](/posts/bms/ad7280a-bms-dev-29/)
- **#30 - PCB 레이아웃** ← 현재 글
- #31 - 부품 선정
- #32 - 제작 및 조립

---

## 참고 자료

- [IPC-2221 Generic Standard on PCB Design](https://www.ipc.org/TOC/IPC-2221B.pdf)
- [High Voltage PCB Design](https://www.altium.com/documentation/altium-designer/high-voltage-pcb-design)
- [Kelvin Connection for Current Sensing](https://www.ti.com/lit/an/sbaa275/sbaa275.pdf)
